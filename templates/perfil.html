{% extends '/dashboard.html' %}

{% block css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

<style>
    body {        
        font-family: 'Poppins', sans-serif;
    }

    .profile-card {
        max-width: 750px;
        background: #fff;
        border-radius: 20px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        padding: 40px;
        margin: 60px auto;
        transition: all 0.3s ease;
    }

    .profile-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 30px rgba(0,0,0,0.12);
    }

    .profile-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .profile-header h2 {
        font-weight: 600;
        color: #2c3e50;
    }

    .profile-header i {
        font-size: 3rem;
        color: #0d6efd;
        margin-bottom: 10px;
    }

    .info-group {
        margin-bottom: 25px;
    }

    .info-group h5 {
        color: #6c757d;
        margin-bottom: 5px;
    }

    .editable-text {
        font-size: 1.2rem;
        color: #212529;
        font-weight: 500;
        background-color: #f8f9fa;
        padding: 10px 15px;
        border-radius: 10px;
    }

    .form-control {
        border-radius: 10px;
        padding: 10px 15px;
        font-size: 1.1rem;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 8px rgba(13, 110, 253, 0.4);
    }

    .action-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 30px;
    }

    .btn {
        border-radius: 30px;
        font-weight: 600;
        padding: 10px 25px;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    .btn-primary:hover {
        background-color: #084298;
    }

    .btn-success {
        background-color: #198754;
        border-color: #198754;
    }

    .btn-success:hover {
        background-color: #146c43;
    }

    .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
    }

    .btn-secondary:hover {
        background-color: #5a6268;
    }

    @media (max-width: 768px) {
        .profile-card {
            padding: 25px;
        }
        .editable-text, .form-control {
            font-size: 1rem;
        }
    }
</style>
{% endblock %}

{% block titulo_pagina %}
Perfil del Docente
{% endblock %}

{% block search %}
{% endblock %}

{% block contenido %}
<div class="profile-card">
    <div class="profile-header">
        <i class="bi bi-person-circle"></i>
        <h2>Perfil del Docente</h2>
        <p class="text-muted">Aquí puedes visualizar y actualizar tu información personal</p>
    </div>

    <div class="info-group">
        <h5>Nombre</h5>
        <p id="nombre" class="editable-text">{{ session['nombres'] }}</p>
        <input type="text" id="editNombre" class="form-control" style="display:none" value="{{ session['nombres'] }}">
    </div>

    <div class="info-group">
        <h5>Apellidos</h5>
        <p id="apellido" class="editable-text">{{ session['apellidos'] }}</p>
        <input type="text" id="editApellido" class="form-control" style="display:none" value="{{ session['apellidos'] }}">
    </div>

    <div class="info-group">
        <h5>Correo electrónico</h5>
        <p id="correo" class="editable-text">{{ session['correo'] }}</p>
        <input type="email" id="editCorreo" class="form-control" style="display:none" value="{{ session['correo'] }}">
    </div>

    <div class="info-group">
        <h5>Contraseña</h5>
        <p id="password" class="editable-text">********</p>
        <input type="password" id="editPassword" class="form-control" style="display:none" placeholder="Nueva contraseña (opcional)">
    </div>


    <div class="action-buttons">
        <button id="btnModificar" class="btn btn-primary"><i class="bi bi-pencil-square me-1"></i>Modificar</button>
        <button id="btnGuardar" class="btn btn-success" style="display:none"><i class="bi bi-save me-1"></i>Guardar</button>
        <button id="btnAtras" class="btn btn-secondary" style="display:none"><i class="bi bi-arrow-left me-1"></i>Atrás</button>
    </div>
</div>

<script>
    // --- Mostrar campos para edición ---
    document.getElementById('btnModificar').addEventListener('click', function() {
        if (confirm("¿Estás seguro de modificar los campos?")) {
            // Mostrar inputs de edición
            document.getElementById('editNombre').style.display = 'block';
            document.getElementById('editApellido').style.display = 'block';
            document.getElementById('editCorreo').style.display = 'block';
            document.getElementById('editPassword').style.display = 'block';

            // Ocultar textos actuales
            document.getElementById('nombre').style.display = 'none';
            document.getElementById('apellido').style.display = 'none';
            document.getElementById('correo').style.display = 'none';
            document.getElementById('password').style.display = 'none';

            // Mostrar/ocultar botones
            document.getElementById('btnModificar').style.display = 'none';  
            document.getElementById('btnGuardar').style.display = 'inline-block'; 
            document.getElementById('btnAtras').style.display = 'inline-block';  
        }
    });

    // --- Guardar cambios ---
    document.getElementById('btnGuardar').addEventListener('click', function() {
        const nombre = document.getElementById('editNombre').value.trim();
        const apellido = document.getElementById('editApellido').value.trim();
        const correo = document.getElementById('editCorreo').value.trim();
        const password = document.getElementById('editPassword').value.trim();

        if (!nombre || !apellido || !correo) {
            alert("Por favor, completa todos los campos obligatorios.");
            return;
        }

        if (confirm("¿Deseas guardar los cambios?")) {
            // Construir datos a enviar
            const dataToSend = { nombre, apellido, correo };
            if (password !== "") dataToSend.password = password; // Solo si se cambió

            fetch('/modificar_perfil', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToSend)
            })
            .then(res => res.json()) 
            .then(data => {
                console.log("Respuesta del servidor:", data);

                if (data.code === 1) {
                    // Actualizar la vista con nuevos valores
                    document.getElementById('nombre').innerText = nombre;
                    document.getElementById('apellido').innerText = apellido;
                    document.getElementById('correo').innerText = correo;
                    document.getElementById('password').innerText = '********';
                    document.getElementById('editPassword').value = ''; // Limpiar campo

                    // Ocultar inputs y mostrar textos actualizados
                    document.getElementById('editNombre').style.display = 'none';
                    document.getElementById('editApellido').style.display = 'none';
                    document.getElementById('editCorreo').style.display = 'none';
                    document.getElementById('editPassword').style.display = 'none';

                    document.getElementById('nombre').style.display = 'block';
                    document.getElementById('apellido').style.display = 'block';
                    document.getElementById('correo').style.display = 'block';
                    document.getElementById('password').style.display = 'block';

                    // Botones
                    document.getElementById('btnGuardar').style.display = 'none';
                    document.getElementById('btnAtras').style.display = 'none';
                    document.getElementById('btnModificar').style.display = 'inline-block';

                    alert('Cambios guardados exitosamente ✅');
                } else {
                    alert('⚠️ Error al guardar los cambios. Inténtalo nuevamente.');
                }
            })
            .catch(error => {
                console.error('Error en la solicitud:', error);
                alert('❌ Hubo un problema al guardar los cambios.');
            });
        }
    });

    // --- Volver atrás sin guardar ---
    document.getElementById('btnAtras').addEventListener('click', function() {
        if (confirm("¿Deseas volver atrás sin guardar los cambios?")) {
            // Ocultar inputs y mostrar los valores actuales
            document.getElementById('editNombre').style.display = 'none';
            document.getElementById('editApellido').style.display = 'none';
            document.getElementById('editCorreo').style.display = 'none';
            document.getElementById('editPassword').style.display = 'none';
            document.getElementById('editPassword').value = '';

            document.getElementById('nombre').style.display = 'block';
            document.getElementById('apellido').style.display = 'block';
            document.getElementById('correo').style.display = 'block';
            document.getElementById('password').style.display = 'block';

            // Restaurar botones
            document.getElementById('btnModificar').style.display = 'inline-block';
            document.getElementById('btnGuardar').style.display = 'none';
            document.getElementById('btnAtras').style.display = 'none';
        }
    });
</script>

{% endblock %}
