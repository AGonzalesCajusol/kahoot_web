<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoQuiz | Panel de Administración</title>

    <!-- Fuentes y estilos -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../static/CSS/dashboard.css">
</head>

<body style="font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f5f8f8; min-height: 100vh; display: flex; flex-direction: column;">

    <!-- ===== NAVBAR SUPERIOR ===== -->
    <nav class="navbar navbar-expand-lg bg-white shadow-sm py-3 fixed-top border-bottom">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary d-flex align-items-center gap-2" href="/dashboard">
                <img src="../static/IMG/GoQuiz.png" alt="Logo" height="34">
                <span>GoQuiz</span>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarGoQuiz">
                <i class="bi bi-list text-primary fs-2"></i>
            </button>

            <div class="collapse navbar-collapse justify-content-end" id="navbarGoQuiz">
                <ul class="navbar-nav align-items-center gap-3">
                    <li><a class="nav-link fw-semibold" href="/dashboard"><i class="bi bi-journal-text me-1"></i>Cuestionarios</a></li>
                    <li><a class="nav-link fw-semibold" href="/nuevo_cuestionario"><i class="bi bi-plus-circle me-1"></i>Crear</a></li>
                    <li><a class="nav-link fw-semibold" href="/repositorio"><i class="bi bi-archive me-1"></i>Repositorio</a></li>
                    {% if session.get('docente_id') %}
                        <!-- Usuario Logueado -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" data-bs-toggle="dropdown">
                                <i class="bi bi-person-circle fs-4 text-primary me-2"></i>
                                <span class="fw-bold">{{ session['nombres'] }}</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 rounded-3">
                                <li><a class="dropdown-item" href="/perfil"><i class="bi bi-person me-2"></i>Mi perfil</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="/logout"><i class="bi bi-box-arrow-right me-2"></i>Salir</a></li>
                            </ul>
                        </li>
                    {% else %}
                        <!-- Usuario NO logueado -->
                        <li><a class="nav-link fw-semibold" href="/login"><i class="bi bi-box-arrow-in-right me-1"></i>Iniciar sesión</a></li>
                        <li><a class="btn btn-primary rounded-pill fw-semibold px-3 py-1" href="/register"><i class="bi bi-person-plus me-1"></i>Registrarse</a></li>
                    {% endif %}

                </ul>
            </div>
        </div>
    </nav>

    <!-- ===== CONTENIDO PRINCIPAL ===== -->
    <main class="flex-grow-1 d-flex align-items-center justify-content-center text-center" style="padding-top: 100px; padding-bottom: 80px;">
        <div class="container">
            <header class="mb-5">
                <h1 class="fw-bold text-primary display-6 mb-3">{% block titulo_pagina %}Mis Cuestionarios{% endblock %}</h1>

                {% block search %}
                    <div class="d-flex justify-content-center">
                        <form class="d-flex justify-content-center w-100" style="max-width: 420px;">
                            <input class="form-control me-2 rounded-pill shadow-sm" type="search" placeholder="Buscar cuestionarios..." aria-label="Buscar">
                            <button class="btn btn-primary rounded-pill"><i class="bi bi-search"></i></button>
                        </form>
                    </div>
                    <button type="button" class="btn btn-outline-primary mt-3" data-bs-toggle="modal" data-bs-target="#abrirmodal">
                        <i class="bi bi-plus-lg"></i> Subir cuestionario
                    </button>
                    <a href="/static/uploads/formato_export.xlsx" type="button" class="btn btn-outline-success mt-3" >
                        <i class="bi bi-file-earmark-arrow-down-fill"></i> Descargar plantilla
                    </a>
                    

                    <!-- Modal -->
                    <div class="modal fade" id="abrirmodal" tabindex="-1" aria-labelledby="abrirmodalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content ">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="abrirmodalLabel">Subir Cuestionario Excel</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    
                                </div>
                                <div class="modal-body">
                                    <form  id="form_cuestionario">
                                        <div class="mb-3">
                                            <label for="archexcel" class="form-label">Seleccionar archivo Excel</label>
                                            <input type="file" class="form-control" id="archexcel" name="excel_archivo" accept=".xlsx,.xls" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary" id="btn_subir">Subir</button>
                                    </form>
                                    <div>
                                        <div class="progress d-none" id="progreso_br">
                                            <div class="progress-bar" id="valor_br" ></div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                {% endblock %}
            </header>

            {% block contenido %}
            <section id="contenido-principal" class="mt-4 text-start mx-auto" style="max-width: 1100px;">
                <h3 class="fw-semibold text-secondary mb-3">Cuestionarios Activos</h3>
                <div class="row g-4 justify-content-center" id="cuestionarios-activos">
                    <!-- Tarjetas dinámicas -->
                </div>

                <h3 class="fw-semibold text-secondary mt-5 mb-3">Cuestionarios Archivados</h3>
                <div class="row g-4 justify-content-center" id="cuestionarios-archivados">
                    <!-- Tarjetas dinámicas -->
                </div>
            </section>

            <div id="sin-contenido" class="text-muted py-5 d-none">
                <i class="bi bi-clipboard-x fs-1 mb-2 d-block"></i>
                <p class="fw-semibold">Aún no tienes cuestionarios registrados.</p>
            </div>
            {% endblock %}
        </div>
    </main>

    <!-- ===== FOOTER ===== -->
    <footer class="text-center text-muted py-4 border-top bg-white small mt-auto">
        © {{ current_year or "2025" }} <strong>GoQuiz</strong> — Todos los derechos reservados.
    </footer>


    <script>
        const docenteId = "{{ session['docente_id'] }}";  // Pasar desde Flask a la plantilla
        if (window.location.pathname === '/dashboard') {        // Cargar cuestionarios activos
            fetch(`/cuestionarios_activos?id_docente=${docenteId}`)
                .then(response => response.json())
                .then(data => {
                    const activosContainer = document.getElementById('cuestionarios-activos');
                    if (!Array.isArray(data) || data.length === 0) {
                        activosContainer.innerHTML = '<p>No se encontraron cuestionarios activos.</p>';
                        return;
                    }
                    activosContainer.innerHTML = data.map(q => {
                        return `
                        <article class="questionnaire-card active">
                            <div class="card-content">
                                <h4>${q.nombre}</h4>
                                <span class="status">Activo</span>
                                <div class="button-group">
                                    <button class="btn btn-primary" onclick="location.href='/modificar_cuestionario/${q.id_cuestionario}'">Modificar</button>
                                    <form action="/iniciar_juego" method="POST" style="display:inline;">
                                        <input type="hidden" name="id_cuestionario" value="${q.id_cuestionario}">
                                        <button type="submit" class="btn btn-success">Iniciar Juego</button>
                                    </form>
                                </div>
                            </div>
                        </article>
                    `;
                    }).join('');
                })
                .catch(error => console.error('Error al cargar los cuestionarios activos:', error));

            // Cargar cuestionarios archivados
            fetch(`/cuestionarios_archivados?id_docente=${docenteId}`)
                .then(response => response.json())
                .then(data => {
                    const archivadosContainer = document.getElementById('cuestionarios-archivados');
                    if (!Array.isArray(data) || data.length === 0) {
                        archivadosContainer.innerHTML = '<p>No se encontraron cuestionarios archivados.</p>';
                        return;
                    }
                    archivadosContainer.innerHTML = data.map(q => {
                        return `
                        <article class="questionnaire-card archived">
                            <div class="card-content">
                                <h4>${q.nombre}</h4>
                                <span class="status">Archivado</span>
                                <div class="button-group">
                                    <button class="btn btn-warning" onclick="location.href='/modificar_cuestionario/${q.id_cuestionario}'">Modificar</button>
                                </div>
                            </div>
                        </article>
                    `;
                    }).join('');
                })
                .catch(error => console.error('Error al cargar los cuestionarios archivados:', error));

        document.getElementById('form_cuestionario').addEventListener('submit', async(event) => {
            event.preventDefault();

            const formulario = event.target;
            const formulario_dato = new FormData(formulario);
            formulario.classList.add('d-none');
            const div_bar = document.getElementById('progreso_br');
            const progress = document.getElementById('valor_br');
            div_bar.classList.remove('d-none');
            let tm = 20;
            progress.style.width = `${tm}%`;
            progress.textContent = `${tm}%`;

            //enviamos 
            const response = await fetch('/subirformulario_excel', {
                method: 'POST',
                body: formulario_dato
            });
            tm = 60;
            progress.style.width = `${tm}%`;
            progress.textContent = `${tm}%`;
            //procesamos mensaje 
            const respuesta = await response.json();
            tm = 100;
            progress.style.width = `${tm}%`;
            progress.textContent = `${tm}%`;

            if(respuesta.estado == true){
                const interval = setInterval(() => {
                    alert(estado.mensaje);
                }, 1000);
                window.location.reload();
            }else{
                formulario.classList.remove('d-none');      
                div_bar.classList.add('d-none');
                alert(respuesta.mensaje);
            }
        });
    
        }


    </script>
            <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    {% block scripts %}
        <!-- ===== SCRIPTS ===== -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>    
        <script src="../static/JS/dashboard.js"></script>
    {% endblock %}
</body>
</html>
