{% extends 'dashboard.html' %}
{% block titulo_pagina %}

{% endblock %}

{% block search %}
<!-- Bloque search vacío para ocultar búsqueda y botones de subir/descargar -->
{% endblock %}

{% block contenido %}
<div class="container-fluid py-4">
    <!-- Vista de solo lectura desde repositorio -->
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">
                <i class="bi bi-eye-fill me-2"></i>Vista del Cuestionario
            </h3>
            <p class="mb-0 mt-2 text-white-50">Modo solo lectura - Este cuestionario pertenece a otro docente</p>
        </div>
        <div class="card-body">
                {% if datos and datos.detalle %}
                    <div class="mb-4">
                        <h4 class="fw-bold mb-3">
                            <i class="bi bi-info-circle text-primary me-2"></i>Información del Cuestionario
                        </h4>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="fw-semibold text-muted">Nombre:</label>
                                <p class="form-control-plaintext bg-light p-2 rounded">{{ datos.detalle.nombre or 'Sin nombre' }}</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="fw-semibold text-muted">Tipo:</label>
                                <p class="form-control-plaintext bg-light p-2 rounded">
                                    {% if datos.detalle.tipo_cuestionario == 'I' %}
                                        <i class="bi bi-person-fill text-info me-1"></i>Individual
                                    {% else %}
                                        <i class="bi bi-people-fill text-warning me-1"></i>Grupal
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="fw-semibold text-muted">Estado:</label>
                                <p class="form-control-plaintext bg-light p-2 rounded">
                                    {% if datos.detalle.estado == 'P' %}
                                        <span class="badge bg-success">Público</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Privado</span>
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="fw-semibold text-muted">Descripción:</label>
                                <p class="form-control-plaintext bg-light p-3 rounded" style="min-height: 80px;">
                                    {{ datos.detalle.descripcion or 'Sin descripción' }}
                                </p>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="mb-4">
                        <h4 class="fw-bold mb-3">
                            <i class="bi bi-question-circle text-primary me-2"></i>Preguntas ({{ datos.respuestas|length }})
                        </h4>
                        {% if datos.respuestas %}
                            <div class="accordion" id="preguntasAccordion">
                                {% for pregunta in datos.respuestas %}
                                    <div class="accordion-item mb-3">
                                        <h2 class="accordion-header" id="heading{{ loop.index }}">
                                            <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button" 
                                                    data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" 
                                                    aria-expanded="{% if loop.first %}true{% else %}false{% endif %}">
                                                <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                                    <span class="fw-semibold">Pregunta {{ loop.index }}</span>
                                                    <div>
                                                        <span class="badge bg-info me-2">
                                                            <i class="bi bi-star-fill"></i> {{ pregunta.puntaje }} pts
                                                        </span>
                                                        <span class="badge bg-secondary">
                                                            <i class="bi bi-clock-fill"></i> {{ pregunta.tiempo_respuesta }}s
                                                        </span>
                                                    </div>
                                                </div>
                                            </button>
                                        </h2>
                                        <div id="collapse{{ loop.index }}" 
                                             class="accordion-collapse collapse {% if loop.first %}show{% endif %}" 
                                             data-bs-parent="#preguntasAccordion">
                                            <div class="accordion-body">
                                                <div class="mb-3">
                                                    <label class="fw-semibold text-muted">Enunciado:</label>
                                                    <p class="form-control-plaintext bg-light p-3 rounded">{{ pregunta.pregunta }}</p>
                                                </div>
                                                <div>
                                                    <label class="fw-semibold text-muted mb-2">Alternativas:</label>
                                                    <div class="list-group" id="alternativas-{{ loop.index }}">
                                                        <!-- Se llenará con JavaScript -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>Este cuestionario no tiene preguntas.
                            </div>
                        {% endif %}
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-4 pt-4 border-top">
                        <a href="/repositorio" class="btn btn-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Volver al Repositorio
                        </a>
                        <button id="btnReutilizar" class="btn btn-success btn-lg">
                            <i class="bi bi-files me-2"></i>Reutilizar Cuestionario
                        </button>
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>No se pudieron cargar los datos del cuestionario.
                    </div>
                {% endif %}
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Procesar alternativas que vienen como JSON
        {% if datos and datos.respuestas %}
            {% for pregunta in datos.respuestas %}
                (function() {
                    const alternativasContainer = document.getElementById('alternativas-{{ loop.index }}');
                    if (!alternativasContainer) return;
                    
                    let alternativas = {{ pregunta.alternativas|tojson|safe }};
                    
                    // Si es string, parsearlo
                    if (typeof alternativas === 'string') {
                        try {
                            alternativas = JSON.parse(alternativas);
                        } catch(e) {
                            alternativas = [];
                        }
                    }
                    
                    // Si no es array, convertirlo
                    if (!Array.isArray(alternativas)) {
                        alternativas = [];
                    }
                    
                    if (alternativas.length === 0) {
                        alternativasContainer.innerHTML = '<p class="text-muted p-3">No hay alternativas disponibles</p>';
                        return;
                    }
                    
                    alternativas.forEach(alt => {
                        const altObj = typeof alt === 'object' ? alt : {respuesta: alt, estado_alternativa: 0};
                        const isCorrect = altObj.estado_alternativa == 1;
                        const item = document.createElement('div');
                        item.className = `list-group-item ${isCorrect ? 'list-group-item-success' : 'list-group-item-light'}`;
                        item.innerHTML = `
                            <div class="d-flex align-items-center">
                                ${isCorrect 
                                    ? '<i class="bi bi-check-circle-fill text-success me-2"></i><strong>' + altObj.respuesta + '</strong><span class="badge bg-success ms-2">Correcta</span>'
                                    : '<i class="bi bi-circle me-2 text-muted"></i><span>' + altObj.respuesta + '</span>'
                                }
                            </div>
                        `;
                        alternativasContainer.appendChild(item);
                    });
                })();
            {% endfor %}
        {% endif %}
        
        // Botón reutilizar - Disponible para cualquier docente que no sea propietario
        const btnReutilizar = document.getElementById('btnReutilizar');
        if (btnReutilizar) {
            btnReutilizar.addEventListener('click', async function() {
                const result = await Swal.fire({
                    title: '¿Reutilizar este cuestionario?',
                    html: '<p class="mb-3">Se creará una copia de este cuestionario público en tu cuenta.</p><p class="text-muted small">Podrás modificarlo y usarlo como desees. El cuestionario original permanecerá intacto.</p>',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: '<i class="bi bi-check-circle me-2"></i>Sí, reutilizar',
                    cancelButtonText: '<i class="bi bi-x-circle me-2"></i>Cancelar',
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#6c757d',
                    reverseButtons: true
                });

                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Reutilizando...',
                        text: 'Por favor espera',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    try {
                        const response = await fetch('/reutilizar_cuestionario/{{ id_cuestionario }}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        const data = await response.json();

                        if (data.estado) {
                            Swal.fire({
                                icon: 'success',
                                title: '¡Cuestionario reutilizado!',
                                html: '<p>' + data.mensaje + '</p><p class="text-muted small mt-2">Ahora puedes modificarlo y usarlo como desees.</p>',
                                confirmButtonText: 'Ir a modificar',
                                confirmButtonColor: '#007bff'
                            }).then(() => {
                                if (data.redirect) {
                                    window.location.href = data.redirect;
                                } else if (data.id_cuestionario) {
                                    window.location.href = '/modificar_cuestionario/' + data.id_cuestionario;
                                } else {
                                    window.location.href = '/dashboard';
                                }
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.mensaje || 'No se pudo reutilizar el cuestionario'
                            });
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Ocurrió un error al reutilizar el cuestionario. Por favor, intenta nuevamente.'
                        });
                    }
                }
            });
        }
    });
</script>
{% endblock %}
